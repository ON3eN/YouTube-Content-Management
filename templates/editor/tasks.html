{% load static %}
{% if user.is_authenticated %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مهام الممنتج</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#922f20; --accent-fg:#922f20;
      --bg:#fffaf9; --border:#e8e6e5;
      --pending:#fff3cd; --confirmed:#e8f5e9; --rejected:#fdecea;
      --chip-pending:#c58a00; --chip-confirmed:#1b7f38; --chip-rejected:#b54545;
      --ring-color:#b54545;   /* لون الحلقة الأمامي */
      --ring-track:#ead9d6;   /* مسار الخلفية */
    }
    body{ margin:0; font-family:'Cairo',sans-serif; background:var(--bg); }
    .main-wrapper{ max-width:1200px; margin:3rem auto; padding:1rem; }

    .titles-wrapper{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1.5rem; }
    .section-title{
      background:#7a2b1d; color:#fff; font-size:1.35rem; font-weight:bold;
      padding:.9rem 1.6rem; border-radius:12px; text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,.06);
    }

    .container{ display:grid; grid-template-columns:1fr 1fr; gap:2rem; align-items:start; }
    .left-col { display:block; }
    .right-col{ display:flex; flex-direction:column; gap:1.5rem; }

    .card{
      background:#fff; border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,.06);
      padding:2rem; box-sizing:border-box; position:relative;
    }

    /* رفع */
    .upload-box{
      width:100%; border:2px dashed #bbb; border-radius:14px; margin-bottom:1rem;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      cursor:pointer; transition:background-color .3s; text-align:center; padding:2rem 1rem;
    }
    .upload-box:hover{ background:#f7f7f7; }
    .upload-box img{ width:50px; opacity:.85; margin-bottom:.6rem; }
    input[type="file"]{ display:none; }
    .btn-submit{
      background:var(--accent); color:#fff; border:none; font-size:1.05rem; font-weight:bold;
      padding:.85rem 2.2rem; border-radius:10px; cursor:pointer; width:100%;
      transition:opacity .2s ease, background .2s ease;
    }
    .btn-submit[disabled]{ opacity:.55; cursor:not-allowed; }
    .btn-submit:hover:not([disabled]){ background:#7a2418; }
    .select-wrap{ margin-bottom:1rem; }
    .select-wrap label{ display:block; margin-bottom:.35rem; font-weight:700; color:#5a4a48; }
    select{ width:100%; padding:.8rem .9rem; border-radius:10px; border:1px solid #ccc; font-family:'Cairo',sans-serif; background:#fff; }

    /* بطاقات فيديو اليوتيوبر */
    .video-card{ position:relative; padding:1rem; border:1px solid var(--border); border-radius:12px; margin-bottom:1.2rem; background:#fff; }
    .video-preview-box{ position:relative; height:220px; width:100%; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#faf7f6; }
    .eye-icon{ font-size:1.6rem; cursor:pointer; position:absolute; color:#7a2b1d; transition:all .3s ease; top:50%; right:50%; transform:translate(50%,-50%); z-index:10; }
    .eye-icon.top-right{ top:10px!important; right:10px!important; transform:none!important; }
    .video-preview-box video{ width:100%; height:100%; object-fit:cover; border-radius:10px; animation:fadeIn .35s ease; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    .video-meta{ font-size:.95rem; color:#333; margin-top:1rem; line-height:1.9; }
    .video-meta .extras{ color:#6a5d5f; background:#fff5f3; border:1px solid #f0d8d3; border-radius:8px; padding:.35rem .6rem; display:inline-block; }

    .download-btn{
      position:absolute; bottom:12px; left:12px; background:var(--accent); color:#fff;
      border:none; border-radius:999px; padding:.45rem 1rem; font-size:.92rem; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.12); transition:transform .15s ease, background .2s ease;
    }
    .download-btn:hover{ background:#7b251a; transform:translateY(-1px); }

    /* حالة المراجعة */
    .review-title{ font-weight:800; font-size:1.12rem; color:#632419; margin-bottom:1rem; }
    .review-list{ display:flex; flex-direction:column; gap:.9rem; }
    .review-item{ border:1px dashed #d8d0cd; border-radius:14px; padding:0.9rem 1rem; background:#fefefe; box-shadow:0 2px 8px rgba(0,0,0,.03); }
    .review-item.pending{  background:var(--pending);   border-color:#ead79b; }
    .review-item.confirmed{background:var(--confirmed); border-color:#aad0b0; }
    .review-item.rejected{ background:var(--rejected);  border-color:#e0a3a3; }
    .ri-top{ display:flex; align-items:center; gap:.75rem; }
    .ri-title{ font-weight:800; color:#3b2e2e; flex:1; line-height:1.5; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ri-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
    .review-item.pending  .ri-dot{ background:#e0b300; }
    .review-item.confirmed .ri-dot{ background:#35a15a; }
    .review-item.rejected  .ri-dot{ background:#d06767; }
    .state-chip{ padding:.25rem .6rem; border-radius:999px; font-size:.85rem; font-weight:800; background:#fff; border:1px solid #eee; }
    .state-chip.pending{ color:var(--chip-pending); border-color:#f2d889; }
    .state-chip.confirmed{ color:var(--chip-confirmed); border-color:#b7dfc1; }
    .state-chip.rejected{ color:var(--chip-rejected); border-color:#efc0c0; }

    /* ====== Ring uploader styles (مطابق للصور) ====== */
    .ring-uploader{
      position: fixed;
      z-index: 99999;
      width: 86px; height: 86px;
      display: none;          /* show via .show */
      filter: drop-shadow(0 10px 26px rgba(0,0,0,.18));
      transition: transform .15s ease, opacity .15s ease;
    }
    .ring-uploader.show{ display:block; opacity:1; }
    .ring-uploader.hide{ opacity:0; transform:scale(.96); }

    .ring-svg{
      width: 86px; height: 86px;
      background: #fff;
      border-radius: 50%;
      border: 3px solid rgba(181,69,69,.28);
    }
    .ring-track{ fill:none; stroke:var(--ring-track); stroke-width:6; }
    .ring-bar{
      fill:none; stroke:var(--ring-color); stroke-width:6; stroke-linecap:round;
      transform: rotate(-90deg); transform-origin: 50% 50%;
      stroke-dasharray: 276;      /* 2πr لِـ r=44 */
      stroke-dashoffset: 276;     /* يبدأ من 0% */
      transition: stroke-dashoffset .08s linear;
    }
    .ring-check{
      stroke: var(--ring-color); stroke-width:7; fill:none;
      stroke-linecap: round; stroke-linejoin: round;
      stroke-dasharray: 80; stroke-dashoffset: 80;
      opacity: 0;
    }
    .ring-uploader.done .ring-check{
      opacity: 1; animation: check-draw .42s ease forwards;
    }
    @keyframes check-draw{ to{ stroke-dashoffset:0; } }

    .ring-badge{
      position:absolute; left:50%; top:100%; transform:translate(-50%, 10px);
      background:#fff; color:var(--ring-color);
      border:2px solid rgba(181,69,69,.55);
      border-radius:999px; padding:2px 10px;
      font-weight:800; font-size:12px; line-height:1.6;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      opacity:1; transition:opacity .25s ease, transform .25s ease;
    }
    .ring-badge.hide{ opacity:0; transform:translate(-50%, 18px); }

    @media (max-width:900px){
      .container{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

  {% include 'header.html' %}

  <div class="main-wrapper">

    <div class="titles-wrapper">
      <div class="section-title">فيديوهات من اليوتيوبر</div>
      <div class="section-title">رفع الفيديو المُمنتج</div>
    </div>

    <div class="container">

      <!-- يسار: فيديوهات من اليوتيوبر -->
      <div class="left-col">
        <div class="card">
          {% if youtuber_videos %}
            {% for v in youtuber_videos %}
              <div class="video-card">
                <div class="video-preview-box" id="pv{{ v.id }}">
                  <div class="eye-icon" id="eye{{ v.id }}" onclick="toggleVideo('{{ v.video_url }}','{{ v.id }}')">👁️</div>
                </div>
                <p class="video-meta">
                  🎬 <strong>العنوان:</strong> {{ v.title }}<br>
                  🕒 <strong>بتاريخ:</strong> {% if v.uploaded_at %}{{ v.uploaded_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}<br>
                  {% if v.extras %}<span class="extras">📝 ملاحظات: {{ v.extras }}</span>{% endif %}
                </p>

                <button
                  type="button"
                  class="download-btn"
                  data-vid="{{ v.id }}"
                  data-url="{{ v.video_url }}"
                  data-filename="{{ v.file_name }}"
                  onclick="downloadWithProgress(this)"
                >تنزيل</button>
              </div>
            {% endfor %}
          {% else %}
            <p class="video-meta">لا يوجد فيديوهات من اليوتيوبر حالياً.</p>
          {% endif %}
        </div>
      </div>

      <!-- يمين: رفع + حالة المراجعة -->
      <div class="right-col">

        <!-- رفع فيديو المُمنتج -->
        <div class="card" id="uploadCard">
          <form id="editorUploadForm" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            <label class="upload-box" for="videoInput" aria-label="اختر ملف الفيديو المُمنتج">
              <img src="{% static 'icons/upload-icon.png' %}" alt="Upload Icon" />
              <p id="uploadText">اضغط هنا لاختيار الفيديو المُمنتج</p>
              <input type="file" name="video" id="videoInput" accept="video/*" required>
            </label>

            <div class="select-wrap">
              <label for="sourceSelect">اختر الفيديو الأصلي من اليوتيوبر (إلزامي)</label>
              <select id="sourceSelect" name="source_video_id" required>
                <option value="" selected disabled>— اختر الفيديو —</option>
                {% for v in youtuber_videos %}
                  <option value="{{ v.id }}">{{ v.title }}{% if v.uploaded_at %} — {{ v.uploaded_at|date:"Y-m-d H:i" }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>

            <button type="submit" id="submitBtn" class="btn-submit" disabled>رفع الفيديو</button>
          </form>
        </div>

        <!-- بطاقة: حالة المراجعة -->
        <div class="card">
          <div class="review-title">حالة المراجعة</div>

          {% if review_items %}
            <div class="review-list">
              {% for it in review_items %}
                <div class="review-item {{ it.status_css }}">
                  <div class="ri-top">
                    <span class="ri-dot"></span>
                    <div class="ri-title">
                      {% firstof it.source_video.title it.title it.file_name %}
                    </div>
                    <span class="state-chip {{ it.status_css }}">
                      {% if it.status == 'pending' %}تحت المراجعة
                      {% elif it.status == 'confirmed' %}مؤكد
                      {% else %}مرفوض{% endif %}
                    </span>
                  </div>

                  {% if it.status == 'rejected' and it.review_note %}
                    <div class="review-note">الملاحظة: {{ it.review_note }}</div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="review-list">
              <div class="review-item pending">
                <div class="ri-top">
                  <span class="ri-dot"></span>
                  <div class="ri-title">لا توجد عناصر حتى الآن</div>
                  <span class="state-chip pending">—</span>
                </div>
              </div>
            </div>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  <!-- ===== دائرة التحميل (مُثبّتة قرب بطاقة الرفع) ===== -->
  <div class="ring-uploader" id="ringUploader" aria-hidden="true">
    <svg class="ring-svg" id="ringSvg" viewBox="0 0 100 100">
      <circle class="ring-track" cx="50" cy="50" r="44" />
      <circle class="ring-bar"   cx="50" cy="50" r="44" />
      <path class="ring-check" id="ringCheck" d="M32 52 L46 66 L72 40" />
    </svg>
    <div class="ring-badge" id="ringBadge">0%</div>
  </div>

  <script>
    const START_PROGRESS_URL_TEMPLATE = "{% url 'editor:start_progress' 0 %}";

    // عناصر الرفع
    const fileInput  = document.getElementById('videoInput');
    const selectEl   = document.getElementById('sourceSelect');
    const submitBtn  = document.getElementById('submitBtn');
    const uploadCard = document.getElementById('uploadCard');

    function toggleSubmitState(){ submitBtn.disabled = !(fileInput.files.length && selectEl.value); }
    fileInput.addEventListener('change', () => {
      const t = document.getElementById('uploadText');
      if (fileInput.files.length) t.textContent = 'تم اختيار: ' + fileInput.files[0].name;
      toggleSubmitState();
    });
    selectEl.addEventListener('change', toggleSubmitState);

    function toggleVideo(url, id){
      const box = document.getElementById('pv'+id);
      const icon = document.getElementById('eye'+id);
      const v = box.querySelector('video');
      if (v){ v.remove(); icon.classList.remove('top-right'); }
      else{
        const vid = document.createElement('video');
        vid.src = url; vid.controls = true; vid.autoplay = true;
        box.insertBefore(vid, icon);
        icon.classList.add('top-right');
      }
    }

    // ===== دائرة التحميل (المنطق) =====
    const ringUI     = document.getElementById('ringUploader');
    const ringBar    = document.querySelector('.ring-bar');
    const ringBadge  = document.getElementById('ringBadge');
    const CIRCUMFERENCE = 276;

    function setProgress(pct){
      const p = Math.max(0, Math.min(100, pct|0));
      ringBar.style.strokeDashoffset = String(CIRCUMFERENCE * (1 - p/100));
      ringBadge.textContent = p + '%';
    }
    function anchorNear(el){
      const r = el.getBoundingClientRect();
      const x = r.right - 18;  // يمين تحت البطاقة
      const y = r.bottom - 12;
      ringUI.style.left = x + 'px';
      ringUI.style.top  = y + 'px';
    }
    function showRing(){
      anchorNear(uploadCard || document.body);
      ringUI.classList.remove('hide','done');
      ringBadge.classList.remove('hide');
      setProgress(0);
      ringUI.classList.add('show');
    }
    function markDone(){
      ringBadge.classList.add('hide');   // تلاشي الرقم
      ringUI.classList.add('done');      // يرسم ✔ داخل الحلقة
      setTimeout(()=> ringUI.classList.add('hide'), 650);
      setTimeout(()=> ringUI.classList.remove('show','hide','done'), 1000);
    }
    ['scroll','resize'].forEach(ev=>{
      window.addEventListener(ev, () => {
        if(ringUI.classList.contains('show')) anchorNear(uploadCard||document.body);
      }, { passive:true });
    });

    // ===== تنزيل: تسجيل "جاري المونتاج" ثم التنزيل
    async function downloadWithProgress(btn){
      const vidId    = btn.dataset.vid;
      const url      = btn.dataset.url;
      const filename = btn.dataset.filename || 'video.mp4';
      const csrf     = document.querySelector('[name=csrfmiddlewaretoken]').value;

      const oldText = btn.textContent;
      btn.disabled = true; btn.textContent = '... تجهيز التنزيل';

      try{
        const postUrl = START_PROGRESS_URL_TEMPLATE.replace(/0\/?$/, String(vidId) + "/");
        const resp = await fetch(postUrl, {
          method: "POST",
          headers: {"X-CSRFToken": csrf, "X-Requested-With": "XMLHttpRequest"},
          credentials: "same-origin"
        });
        const data = await resp.json().catch(()=> ({}));
        if (!resp.ok || !data.ok) throw new Error((data && data.error) || ('HTTP ' + resp.status));

        const downloadUrl = url + (url.includes('?') ? '&' : '?') + 'fl_attachment=' + encodeURIComponent(filename);
        const r = await fetch(downloadUrl, { mode: 'cors' });
        if(!r.ok) throw new Error('HTTP ' + r.status);
        const blob = await r.blob();
        const objUrl = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = objUrl; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(objUrl);

        btn.textContent = 'تم البدء • حمل الملف';
      }catch(e){
        alert('فشل تسجيل/تنزيل الملف: ' + e.message);
        btn.textContent = oldText;
      }finally{
        btn.disabled = false;
      }
    }

    // ===== رفع الفيديو بمتابعة تقدّم حقيقي (XHR progress)
    const form = document.getElementById('editorUploadForm');
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      const source = selectEl.value;
      if (!source){ alert('اختر الفيديو الأصلي قبل الرفع.'); return; }
      if (!file){ alert('اختر ملف الفيديو.'); return; }

      const fd = new FormData(form);
      const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;

      const xhr = new XMLHttpRequest();
      xhr.open('POST', window.location.href, true);
      xhr.setRequestHeader('X-CSRFToken', csrf);

      showRing();  // إظهار الدائرة

      xhr.upload.onprogress = (ev) => {
        if (ev.lengthComputable) {
          const percent = Math.round((ev.loaded / ev.total) * 100);
          setProgress(percent);
        }
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          try{
            const res = JSON.parse(xhr.responseText || '{}');
            if (xhr.status >= 200 && xhr.status < 300 && res.success){
              setProgress(100);
              markDone();                 // تلاشي الرقم + رسم الصح
              setTimeout(() => window.location.reload(), 900);
            } else {
              ringUI.classList.remove('show');
              alert('حدث خطأ أثناء الرفع: ' + (res.error || ('HTTP ' + xhr.status)));
            }
          }catch(_){
            ringUI.classList.remove('show');
            alert('فشل معالجة الاستجابة من الخادم.');
          }
        }
      };

      xhr.onerror = () => { ringUI.classList.remove('show'); alert('فشل الاتصال بالخادم.'); };

      xhr.send(fd);
    });
  </script>

</body>
</html>
{% else %}
  <script>window.location.href = "{% url 'login' %}";</script>
{% endif %}
