{% load static %}
{% if user.is_authenticated %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>مهام اليوتيوبر</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#922f20;
      --accent-glow: rgba(146,47,32,.35);
    }

    body{ margin:0; font-family:'Cairo',sans-serif; background:#fffaf9; }

    .container{
      max-width:1200px; margin:3rem auto; padding:0 1rem;
      display:flex; flex-wrap:wrap; gap:2rem; justify-content:space-between;
    }

    .section-title{
      background:#7a2b1d; color:#fff; padding:1rem 2rem; text-align:center;
      border-radius:16px; font-size:1.6rem; font-weight:bold; margin-bottom:2rem;
    }

    .card{
      flex:1 1 48%; background:#fff; border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,.06);
      padding:2rem; box-sizing:border-box; position:relative;
    }

    .upload-box{
      width:100%; height:180px; border:2px dashed #bbb; border-radius:14px;
      margin-bottom:2rem; display:flex; flex-direction:column; align-items:center; justify-content:center;
      cursor:pointer; transition:background-color .3s; text-align:center;
    }
    .upload-box:hover{ background:#f7f7f7; }
    .upload-box img{ width:50px; opacity:.85; margin-bottom:.6rem; }
    input[type="file"]{ display:none; }

    .extras-input{
      width:100%; padding:1rem; font-size:1rem; border-radius:10px; border:1px solid #ccc;
      margin-bottom:1.5rem; font-family:'Cairo',sans-serif;
    }

    .btn-submit{
      background:var(--accent); color:#fff; border:none; font-size:1.1rem; font-weight:bold;
      padding:.9rem 2.5rem; border-radius:10px; cursor:pointer;
    }
    .btn-submit:hover{ background:#7a2418; }

    .video-card{
      position:relative; padding:1rem; border:1px solid #ddd; border-radius:12px; margin-bottom:2rem; background:#fff; min-height:300px;
    }
    .video-preview-box{
      position:relative; height:220px; width:100%; border-radius:10px; overflow:hidden;
      display:flex; align-items:center; justify-content:center; background:transparent;
    }
    .eye-icon{
      font-size:1.6rem; cursor:pointer; position:absolute; color:#7a2b1d; transition:all .4s ease;
      top:50%; right:50%; transform:translate(50%,-50%); z-index:10;
    }
    .eye-icon.top-right{ top:10px!important; right:10px!important; transform:none!important; }

    .video-preview-box video{ width:100%; height:100%; object-fit:cover; border-radius:10px; animation:fadeIn .4s ease; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .video-meta{ font-size:.95rem; color:#333; margin-top:1.2rem; }
    .edit-icon{ font-size:1rem; color:#888; cursor:pointer; margin-right:.4rem; opacity:.5; }
    .edit-icon:hover{ opacity:1; color:#555; }

    .delete-btn{
      position:absolute; top:10px; left:10px; background:#ffdddd; color:#c00; border:none;
      border-radius:50%; width:30px; height:30px; font-weight:bold; cursor:pointer;
    }
    .delete-btn:hover{ background:#ffcccc; }

    @media (max-width:900px){ .card{ flex:1 1 100%; } }

    /* ===================== Overlay ===================== */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      z-index:9999; display:flex; justify-content:center; align-items:center;
      opacity:0; pointer-events:none; transition:opacity .35s ease;
      -webkit-user-select:none; user-select:none;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .overlay.hide{ opacity:0; pointer-events:none; }

    .faceid-box{ display:flex; flex-direction:column; align-items:center; gap:1rem; }
    .faceid{
      width:150px; height:150px; position:relative;
      filter: drop-shadow(0 0 18px var(--accent-glow));
      transform: scale(.96); opacity:0; pointer-events:none;
      animation: faceIntro .35s ease forwards;
    }
    @keyframes faceIntro{ to{ transform:scale(1); opacity:1 } }

    .faceid-svg{ width:100%; height:100%; display:block; }

    .track{
      fill:none; stroke:rgba(146,47,32,.12); stroke-width:6;
      transform:rotate(-90deg); transform-origin:50% 50%;
    }

    .ring{
      fill:none; stroke:var(--accent); stroke-width:6; stroke-linecap:round;
      filter: drop-shadow(0 0 8px var(--accent-glow));
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: opacity .35s ease, stroke .4s ease, filter .4s ease;
    }
    .ring-error{
      stroke:#ff3b30;
      filter: drop-shadow(0 0 16px rgba(255,59,48,.45));
    }

    .running .ring{ opacity:.95; }
    .running .faceid{ animation: faceIntro .35s ease forwards, pulse 1.7s ease-in-out infinite; }
    .to-ring .ring{ opacity:1; }

    .check, .x{
      fill:none; stroke:var(--accent); stroke-width:6; stroke-linecap:round; stroke-linejoin:round;
      filter: drop-shadow(0 0 8px var(--accent-glow));
    }
    .check{ stroke-dasharray:120; stroke-dashoffset:120; opacity:0; }
    .x{ stroke:#ff3b30; stroke-dasharray:45; stroke-dashoffset:45; opacity:0; }

    .show-check .check{ animation: draw .7s ease forwards; opacity:1; }
    .show-x .x.x1{ animation: draw .45s ease forwards; opacity:1; }
    .show-x .x.x2{ animation: draw .45s ease forwards .15s; opacity:1; }

    .upload-status{ color:#fff; font-weight:bold; }
    #percentLabel{ transition: opacity .25s ease, transform .25s ease; }

    @keyframes draw{ to{ stroke-dashoffset:0; } }
    @keyframes pulse{
      0%,100%{ filter: drop-shadow(0 0 14px var(--accent-glow)); transform:scale(1); }
      50%{    filter: drop-shadow(0 0 22px var(--accent-glow)); transform:scale(1.02); }
    }
  </style>
</head>
<body>

{% include 'header.html' %}

<div class="overlay" id="uploadOverlay" aria-hidden="true">
  <div class="faceid-box" role="status" aria-live="polite">
    <div class="faceid running" id="faceid">
      <svg class="faceid-svg" viewBox="0 0 100 100" aria-hidden="true">
        <circle class="track" cx="50" cy="50" r="38" />
        <circle class="ring" id="progressRing" cx="50" cy="50" r="38" />
        <text id="percentLabel" x="50" y="54" text-anchor="middle"
              style="fill:#fff; font-weight:700; font-size:16px; font-family:'Cairo', sans-serif;">0%</text>
        <path class="check" id="checkPath" d="M30 52 L45 65 L70 35"/>
        <path class="x x1" id="x1" d="M34 34 L66 66"/>
        <path class="x x2" id="x2" d="M66 34 L34 66"/>
      </svg>
    </div>
    <div class="upload-status" id="uploadStatus">جاري رفع الفيديو...</div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="section-title">رفع فيديو جديد</div>
    <form id="uploadForm" enctype="multipart/form-data">
      {% csrf_token %}
      <label class="upload-box" for="videoInput">
        <img src="{% static 'icons/upload-icon.png' %}" alt="Upload Icon" />
        <p id="uploadText">اضغط هنا لرفع فيديو جديد</p>
        <input type="file" name="video" id="videoInput" accept="video/*" onchange="showFileName(this)" required>
      </label>
      <input type="text" name="title" id="videoTitle" class="extras-input" placeholder="اسم الفيديو" required>
      <input type="text" name="extras" id="videoExtras" class="extras-input" placeholder="إضافات (اختياري)">
      <button type="submit" class="btn-submit">رفع الفيديو</button>
    </form>
  </div>

  <div class="card">
    <div class="section-title">قائمة الفيديوهات المرفوعة</div>
    {% for v in uploaded_videos %}
      <div class="video-card">
        <form method="POST" action="{% url 'youtuber:delete_video' v.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="delete-btn" title="حذف الفيديو">×</button>
        </form>
        <div class="video-preview-box" id="previewBox{{ v.id }}">
          <div class="eye-icon" id="eyeIcon{{ v.id }}" onclick="toggleVideo('{{ v.video_url }}', '{{ v.id }}')">👁️</div>
        </div>
        <p class="video-meta">
          🎬 <strong>الاسم:</strong> {{ v.title }} <span class="edit-icon">✎</span><br>
          📁 <strong>الملف:</strong> {{ v.file_name }}<br>
          🕒 <strong>بتاريخ:</strong> {{ v.uploaded_at|date:"Y-m-d H:i" }}<br>
          📝 <strong>ملاحظات:</strong> {{ v.extras|default:"-" }} <span class="edit-icon">✎</span>
        </p>
      </div>
    {% empty %}
      <p class="video-meta">لا يوجد فيديوهات مرفوعة بعد.</p>
    {% endfor %}
  </div>
</div>

<script>
  function showFileName(input){
    const text = document.getElementById('uploadText');
    if (input.files.length > 0) text.textContent = 'تم اختيار: ' + input.files[0].name;
  }
  function toggleVideo(url, id){
    const box = document.getElementById('previewBox' + id);
    const icon = document.getElementById('eyeIcon' + id);
    const isPlaying = box.querySelector('video');
    if (isPlaying){
      isPlaying.style.animation='fadeOut .3s ease';
      setTimeout(()=>{ isPlaying.remove(); icon.classList.remove('top-right'); }, 280);
    }else{
      const video=document.createElement('video');
      video.src=url; video.controls=true; video.autoplay=true;
      video.style.animation='fadeIn .4s ease';
      box.insertBefore(video, icon);
      icon.classList.add('top-right');
    }
  }

  // ===== التقدّم الدائري (filled + gap) =====
  const R = 38, CIRC = 2*Math.PI*R;
  let currentPct = 0, animFrame=null;
  let slowTimer=null, creepTimer=null;
  let finishedFromServer=false;

  const ringEl = document.getElementById('progressRing');
  ringEl.setAttribute('stroke-dasharray', `0 ${CIRC.toFixed(2)}`);
  ringEl.setAttribute('stroke-dashoffset', '0');

  function drawProgress(pct){
    const label = document.getElementById('percentLabel');
    const clamped = Math.max(0, Math.min(100, pct));
    const filled = (CIRC * clamped) / 100;
    const gap    = Math.max(0, CIRC - filled);
    ringEl.setAttribute('stroke-dasharray', `${filled.toFixed(2)} ${gap.toFixed(2)}`);
    ringEl.setAttribute('stroke-dashoffset', '0');
    label.textContent = `${Math.round(clamped)}%`;
  }

  function animateTo(targetPct, duration=350){
    cancelAnimationFrame(animFrame);
    const start = currentPct;
    const delta = targetPct - start;
    const t0 = performance.now();
    const step = (t)=>{
      const p = Math.min(1, (t - t0) / duration);
      const eased = p < .5 ? 2*p*p : -1 + (4 - 2*p)*p; // easeInOutQuad
      currentPct = start + delta * eased;
      drawProgress(currentPct);
      if (p < 1) animFrame = requestAnimationFrame(step);
    };
    animFrame = requestAnimationFrame(step);
  }

  function showOverlay(){
    const overlay = document.getElementById('uploadOverlay');
    overlay.classList.remove('hide');
    overlay.classList.add('show');
  }
  function fadeOutOverlay(after=0){
    const overlay = document.getElementById('uploadOverlay');
    setTimeout(()=>{ overlay.classList.remove('show'); overlay.classList.add('hide'); }, after);
  }

  function startFaceIDUI(){
    const face = document.getElementById('faceid');
    const status = document.getElementById('uploadStatus');
    const label = document.getElementById('percentLabel');

    face.classList.remove('to-ring','show-check','show-x');
    ringEl.classList.remove('ring-error');
    face.classList.add('running');
    showOverlay();
    status.textContent='جاري رفع الفيديو...';

    finishedFromServer = false;
    currentPct = 0;
    drawProgress(0);
    label.style.opacity = 1;
    label.style.transform = 'scale(1)';

    clearInterval(slowTimer); clearInterval(creepTimer);
    slowTimer = setInterval(()=>{
      if (finishedFromServer) { clearInterval(slowTimer); return; }
      if (currentPct < 95){
        const next = Math.min(95, currentPct + 1.0);
        animateTo(next, 230);
      }else{
        clearInterval(slowTimer);
        creepTimer = setInterval(()=>{
          if (finishedFromServer) { clearInterval(creepTimer); return; }
          if (currentPct < 99){
            const next = Math.min(99, currentPct + 0.05);
            animateTo(next, 260);
          }
        }, 200);
      }
    }, 150);
  }

  // ينتظر انتهاء انتقال (opacity/transform) لعنصر ما، مع مهلة احتياط
  function waitForTransitionEnd(el, timeout=400){
    return new Promise(resolve=>{
      let done=false;
      const finish=()=>{ if(!done){ done=true; el.removeEventListener('transitionend', onEnd); resolve(); } };
      const onEnd=(e)=>{ if(e.target===el) finish(); };
      el.addEventListener('transitionend', onEnd);
      setTimeout(finish, timeout); // fallback
    });
  }

  async function finishToHundredThenCheck(){
    const face = document.getElementById('faceid');
    const status = document.getElementById('uploadStatus');
    const label = document.getElementById('percentLabel');

    finishedFromServer = true;
    clearInterval(slowTimer); clearInterval(creepTimer);

    // أكمل لـ 100
    await new Promise(r=>{ animateTo(100, 500); setTimeout(r, 520); });

    // أخفي الرقم ثم انتظر انتهاء التلاشي مباشرة
    label.style.opacity = 0;
    label.style.transform = 'scale(.85)';
    await waitForTransitionEnd(label, 350); // ⬅️ هنا الربط المباشر

    // أوقف النبض وأظهر الصح فوراً بعد اختفاء الرقم
    face.classList.remove('running');
    face.classList.add('to-ring','show-check');
    status.textContent = 'تم الرفع بنجاح!';

    // تلاشي النافذة ثم تحديث
    fadeOutOverlay(1000);
    setTimeout(()=> window.location.reload(), 1500);
  }

  function finishWithErrorX(){
    const face = document.getElementById('faceid');
    const status = document.getElementById('uploadStatus');
    const label = document.getElementById('percentLabel');

    finishedFromServer = true;
    clearInterval(slowTimer); clearInterval(creepTimer);

    ringEl.classList.add('ring-error');

    setTimeout(()=>{ label.style.opacity = 0; label.style.transform = 'scale(.85)'; }, 350);

    setTimeout(()=>{
      face.classList.remove('running');
      face.classList.add('to-ring','show-x');
      status.textContent = 'حدث خطأ أثناء رفع الفيديو ❌';
    }, 700);

    fadeOutOverlay(3000);
  }

  // ===== رفع الفيديو =====
  document.getElementById('uploadForm').addEventListener('submit', function(e){
    e.preventDefault();

    const file  = document.getElementById('videoInput').files[0];
    const title = document.getElementById('videoTitle').value.trim();
    const extras= document.getElementById('videoExtras').value.trim();
    if(!file){ alert('يرجى اختيار ملف فيديو أولاً'); return; }
    if(!title){ alert('يرجى إدخال اسم الفيديو'); return; }

    startFaceIDUI();

    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const formData = new FormData();
    formData.append('video', file);
    formData.append('title', title);
    formData.append('extras', extras);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', "{% url 'youtuber:upload_video' %}", true);
    xhr.setRequestHeader('X-CSRFToken', csrf);

    xhr.upload.onprogress = (e) => {
      if (!e.lengthComputable || finishedFromServer) return;
      if (currentPct < 95){
        const real = (e.loaded / e.total) * 100;
        const target = Math.min(95, Math.max(currentPct, real - 0.5));
        animateTo(target, 180);
      }
    };

    xhr.onreadystatechange = () => {
      if (xhr.readyState !== 4) return;
      let data = {};
      try{ data = JSON.parse(xhr.responseText || '{}'); }catch(_){}
      if (xhr.status >= 200 && xhr.status < 300 && data.success) {
        finishToHundredThenCheck();
      } else {
        finishWithErrorX();
      }
    };

    xhr.onerror = () => { finishWithErrorX(); };
    xhr.send(formData);
  });
</script>

</body>
</html>
{% else %}
<script>window.location.href = "{% url 'login' %}";</script>
{% endif %}
