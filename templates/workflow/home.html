{% load static %}
{% if user.is_authenticated %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>الرئيسية</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#7a2e1d;
      --bg:#fff7f5;
      --chip-red:#7a2e1d;
      --chip-green:#4caf50;
      --chip-orange:#d69b33;
      --chip-gray:#e0e0e0;
      --text:#1e1e1e;
    }

    body{ margin:0; font-family:'Cairo',sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:1300px; margin:0 auto; padding:1rem; }

    .top-section{ display:flex; gap:1rem; margin-top:2rem; }
    .card{ flex:1; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); display:flex; flex-direction:column; }
    .card-header{ background:var(--brand); color:#fff; padding:1rem; font-weight:bold; font-size:1.1rem; border-radius:12px 12px 0 0; text-align:center; }
    .card-body{ padding:0; flex:1; display:flex; flex-direction:column; }

    /* الدردشة */
    .chat-messages{ padding:1rem; flex:1; overflow-y:auto; max-height:250px; display:flex; flex-direction:column; gap:.5rem; }
    .chat-message{ display:flex; flex-direction:column; max-width:90%; padding:.6rem 1rem; border-radius:12px; align-self:flex-start; }
    .chat-message.my-message{ background:#e0e0e0; align-self:flex-end; }
    .chat-message.youtuber{ background:#ffe5e5; }
    .chat-message.editor{ background:#f3e5f5; }
    .chat-message.thumbnailer{ background:#e3f2fd; }
    .chat-message.reviewer{ background:#e8f5e9; }
    .chat-message.publisher{ background:#fff9e1; }
    .message-bubble{ font-size:.95rem; color:#222; }
    .sender-name{ font-weight:bold; margin-bottom:.2rem; }
    .sender-name.youtuber{ color:#e53935; }
    .sender-name.editor{ color:#9c27b0; }
    .sender-name.thumbnailer{ color:#2196f3; }
    .sender-name.reviewer{ color:#4caf50; }
    .sender-name.publisher{ color:#f9a825; }
    .sender-name.self{ color:var(--brand); }
    .chat-input{ display:flex; align-items:center; padding:1rem; gap:.5rem; border-top:1px solid #eee; }
    .chat-input input{ flex:1; padding:.6rem; border-radius:8px; border:1px solid #ccc; }
    .chat-input button{ padding:.6rem 1.2rem; background:var(--brand); color:#fff; border:none; border-radius:8px; cursor:pointer; }

    /* جدول سير العمل (سطر لكل فيديو) */
    .workflow-board{ margin-top:2rem; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.06); }
    .wf-header{
      display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr 1fr;
      gap:.5rem; background:var(--brand); color:#fff;
      padding:.8rem 1rem; border-radius:12px 12px 0 0;
    }
    .wf-header > div{ text-align:center; font-weight:bold; font-size:1rem; }
    .wf-body{ padding:.4rem 1rem 1rem; }
    .wf-row{
      display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr 1fr; gap:.5rem;
      align-items:center; background:#fff; border:1px solid #f0e5e2; border-radius:10px;
      padding:.6rem .7rem; margin-bottom:.5rem;
    }

    .status-cell{ text-align:center; }
    .chip{ display:inline-block; padding:.3rem .8rem; border-radius:999px; font-size:.85rem; font-weight:500; color:#fff; white-space:nowrap; }
    .chip.red{ background:var(--chip-red); }
    .chip.green{ background:var(--chip-green); }
    .chip.orange{ background:var(--chip-orange); }
    .chip.gray{ background:var(--chip-gray); color:#333; }
    .chip.brand{ background:var(--brand); } /* شارة الفيديو */

    .stamp{ color:#333; font-size:.75rem; display:block; margin-top:.25rem; }

    /* التاريخ يسار والوقت يمين — سطر واحد ومسافة قصيرة */
    .stamp-row{
      margin:.25rem auto 0;
      display:flex;
      justify-content:center; /* الاثنين جنب بعض */
      align-items:center;
      gap:.35rem;              /* مسافة قصيرة */
      direction:ltr;          /* يضمن: التاريخ يسار والوقت يمين */
      color:#333;
      font-size:.78rem;
    }

    /* عمود المراجعة: حالتان جنب بعض */
    .review-stack{ display:flex; gap:.6rem; justify-content:center; align-items:flex-start; }
    .review-item{ display:flex; flex-direction:column; align-items:center; }

    @media (max-width:1000px){
      .wf-header, .wf-row{ grid-template-columns:1fr 1fr 1fr; }
      .wf-header > div:nth-child(4), .wf-header > div:nth-child(5){ display:none; }
      .wf-row > div:nth-child(4), .wf-row > div:nth-child(5){ display:none; }
    }
    @media (max-width:700px){
      .top-section{ flex-direction:column; }
      .wf-header, .wf-row{ grid-template-columns:1fr; }
      .wf-header > div:not(:first-child){ display:none; }
    }
  </style>
</head>
<body>
  {% include 'header.html' %}

  <div class="container">

    <!-- البطاقات الثلاث -->
    <div class="top-section">
      <div class="card">
        <div class="card-header">بطاقة إضافية 2</div>
        <div class="card-body"></div>
      </div>

      <div class="card">
        <div class="card-header">بطاقة إضافية 1</div>
        <div class="card-body"></div>
      </div>

      <!-- الدردشة الجماعية -->
      <div class="card">
        <div class="card-header">الدردشة الجماعية</div>
        <div class="card-body">
          <div class="chat-messages">
            {% if messages %}
              {% for message in messages %}
                {% with role=message.sender.profile.الوظيفة %}
                  {% if message.sender == request.user %}
                    <div class="chat-message my-message {{ role }}">
                      <div class="sender-name self">أنت:</div>
                      <div class="message-bubble">{{ message.content }}</div>
                    </div>
                  {% else %}
                    <div class="chat-message {{ role }}">
                      <div class="sender-name {{ role }}">{{ message.sender.profile.get_الوظيفة_display }} - {{ message.sender.username }}</div>
                      <div class="message-bubble">{{ message.content }}</div>
                    </div>
                  {% endif %}
                {% endwith %}
              {% endfor %}
            {% else %}
              <p style="text-align:center; color:#999;">لا توجد رسائل بعد</p>
            {% endif %}
          </div>
          <form method="POST" class="chat-input">
            {% csrf_token %}
            <input type="text" name="content" placeholder="اكتب رسالتك..." required>
            <button type="submit">إرسال</button>
          </form>

          <script>
            window.addEventListener('load', () => {
              const chatBox = document.querySelector('.chat-messages');
              if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            });
          </script>
        </div>
      </div>
    </div>

    <!-- جدول سير العمل: سطر لكل فيديو -->
    <div class="workflow-board">
      <div class="wf-header">
        <div>الفيديو</div>
        <div>الممنتج</div>
        <div>مصمم الثمنيل</div>
        <div>المراجعة</div>
        <div>مسؤول النشر</div>
      </div>

      <div class="wf-body">
        {% if youtuber_videos %}
          {% for v in youtuber_videos %}
            <div class="wf-row">

              <!-- الفيديو -->
              <div class="status-cell">
                <span class="chip brand" title="{{ v.file_name|default:v.title }}">{{ v.title }}</span>
                {% if v.uploaded_at %}
                  <div class="stamp-row">
                    <span>{{ v.uploaded_at|date:"Y-m-d" }}</span>
                    <span>{{ v.uploaded_at|date:"H:i" }}</span>
                  </div>
                {% else %}
                  <span class="stamp">--:--</span>
                {% endif %}
              </div>

              <!-- الممنتج -->
              <div class="status-cell">
                <span class="chip orange">جاري المونتاج</span>
                <span class="stamp">--:--</span>
              </div>

              <!-- مصمم الثمنيل -->
              <div class="status-cell">
                <span class="chip green">تم التصميم</span>
                <span class="stamp">1:05 م</span>
              </div>

              <!-- المراجعة: فيديو + ثمنيل (جنب بعض) -->
              <div class="status-cell">
                <div class="review-stack">
                  <div class="review-item">
                    <span class="chip red">فيديو غير جاهز</span>
                    <span class="stamp">--:--</span>
                  </div>
                  <div class="review-item">
                    <span class="chip orange">ثمنيل بانتظار المراجعة</span>
                    <span class="stamp">--:--</span>
                  </div>
                </div>
              </div>

              <!-- مسؤول النشر -->
              <div class="status-cell">
                <span class="chip red">لم يتم النشر</span>
                <span class="stamp">--:--</span>
              </div>

            </div>
          {% endfor %}
        {% else %}
          <div class="wf-row" style="grid-template-columns:1fr;">
            <div style="text-align:center; color:#888;">لا يوجد فيديوهات مرفوعة بعد.</div>
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</body>
</html>
{% endif %}
